/*
 * Copyright (c) 2017 Nordic Semiconductor ASA
 * Copyright (c) 2016-2017 Linaro Limited
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#ifndef ZEPHYR_DFU_BOOT_MCUBOOT_H_
#define ZEPHYR_DFU_BOOT_MCUBOOT_H_

#include <storage/flash_map.h>

#define DT_CODE_PARTITION_NODE DT_CHOSEN(zephyr_code_partition)
#define DT_IMAGE_0_NODE DT_NODE_BY_FIXED_PARTITION_LABEL(image_0)
#define DT_IMAGE_1_NODE DT_NODE_BY_FIXED_PARTITION_LABEL(image_1)
#define DT_IMAGE_0_NS_NODE DT_NODE_BY_FIXED_PARTITION_LABEL(image_0_nonsecure)
#define DT_IMAGE_1_NS_NODE DT_NODE_BY_FIXED_PARTITION_LABEL(image_1_nonsecure)

#define IS_IMAGE_CODE_PARTITION(image) \
	DT_SAME_NODE(DT_CODE_PARTITION_NODE, image)

/*
 * If code partition is selected via chosen zephyr,code-partition it should
 * be possible to automatically detect primary and secondary partition.
 */
#if DT_NODE_EXISTS(DT_CODE_PARTITION_NODE)
/* Set PRIMARY to code-partition */
#define FLASH_AREA_IMAGE_PRIMARY DT_FIXED_PARTITION_ID(DT_CODE_PARTITION_NODE)

/* Secondary is the "other" partition in set */
#if DT_NODE_EXISTS(DT_IMAGE_1_NODE) && IS_IMAGE_CODE_PARTITION(DT_IMAGE_0_NODE)
#define FLASH_AREA_IMAGE_SECONDARY DT_FIXED_PARTITION_ID(DT_IMAGE_1_NODE)
#elif IS_IMAGE_CODE_PARTITION(DT_IMAGE_1_NODE)
#define FLASH_AREA_IMAGE_SECONDARY DT_FIXED_PARTITION_ID(DT_IMAGE_0_NODE)
#elif IS_IMAGE_CODE_PARTITION(DT_IMAGE_0_NS_NODE)
#define FLASH_AREA_IMAGE_SECONDARY DT_FIXED_PARTITION_ID(DT_IMAGE_1_NS_NODE)
#elif IS_IMAGE_CODE_PARTITION(DT_IMAGE_1_NS_NODE)
#define FLASH_AREA_IMAGE_SECONDARY DT_FIXED_PARTITION_ID(DT_IMAGE_0_NS_NODE)
#else
/* The naming of partitions is different than expected */
#error Could not determine image partitions for DFU
#endif

#else /* DT_NODE_EXISTS(DT_CODE_PARTITION_NODE), Non-automatic image setup */

/* FLASH_AREA_ID() values used below are auto-generated by DT */
#ifdef CONFIG_TRUSTED_EXECUTION_NONSECURE
#define FLASH_AREA_IMAGE_PRIMARY FLASH_AREA_ID(image_0_nonsecure)
#define FLASH_AREA_IMAGE_SECONDARY FLASH_AREA_ID(image_1_nonsecure)
#else
#define FLASH_AREA_IMAGE_PRIMARY FLASH_AREA_ID(image_0)
#if FLASH_AREA_LABEL_EXISTS(image_1)
#define FLASH_AREA_IMAGE_SECONDARY FLASH_AREA_ID(image_1)
#endif
#endif /* CONFIG_TRUSTED_EXECUTION_NONSECURE */

#endif /* DT_NODE_EXISTS(DT_CODE_PARTITION_NODE) */

#define BOOT_MAGIC_GOOD    1
#define BOOT_MAGIC_BAD     2
#define BOOT_MAGIC_UNSET   3
#define BOOT_MAGIC_ANY     4  /* NOTE: control only, not dependent on sector */
#define BOOT_MAGIC_NOTGOOD 5  /* NOTE: control only, not dependent on sector */

#define BOOT_FLAG_SET   1
#define BOOT_FLAG_BAD   2
#define BOOT_FLAG_UNSET 3
#define BOOT_FLAG_ANY   4  /* NOTE: control only, not dependent on sector */

#endif /* ZEPHYR_DFU_BOOT_MCUBOOT_H_ */
